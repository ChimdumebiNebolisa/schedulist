<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Schedulist{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet"
    >

    <script>
        (function () {
            const storageKey = 'theme';

            const getStoredTheme = () => {
                try {
                    return window.localStorage.getItem(storageKey);
                } catch (error) {
                    return null;
                }
            };

            const setStoredTheme = (theme) => {
                try {
                    window.localStorage.setItem(storageKey, theme);
                } catch (error) {
                    /* storage might be unavailable */
                }
            };

            const getPreferredTheme = () => {
                const storedTheme = getStoredTheme();
                if (storedTheme) {
                    return storedTheme;
                }
                const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
                return mediaQuery && mediaQuery.matches ? 'dark' : 'light';
            };

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-bs-theme', theme);
            };

            applyTheme(getPreferredTheme());

            window.schedulistTheme = {
                getStoredTheme,
                setStoredTheme,
                getPreferredTheme,
                applyTheme,
            };
        })();
    </script>

    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    >
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
</head>
<body
    class="d-flex flex-column min-vh-100 page-transition{% block body_class %}{% endblock body_class %}"
>
    {% set current_endpoint = request.endpoint or '' %}

    <nav class="navbar navbar-expand-lg bg-white">
        <div class="container align-items-center">
            <a class="navbar-brand fw-semibold" href="{{ url_for('index') }}">
                Schedulist
            </a>

            {% if user and user.get('name') %}
                <div class="navbar-title-mobile d-lg-none flex-grow-1 fw-semibold text-center">
                    Schedulist
                </div>
            {% endif %}

            <div class="d-flex align-items-center gap-2 ms-auto d-lg-none">
                <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm theme-toggle"
                    data-theme-toggle
                    aria-label="Switch to dark mode"
                    aria-pressed="false"
                >
                    <span class="theme-toggle-icon" aria-hidden="true">ðŸŒž</span>
                    <span class="visually-hidden">Toggle theme</span>
                </button>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav"
                    aria-controls="navbarNav"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-lg-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        {% set dashboard_active = current_endpoint == 'index' %}
                        <a
                            class="nav-link d-flex align-items-center gap-2 {{ 'active' if dashboard_active }}"
                            {% if dashboard_active %}aria-current="page"{% endif %}
                            href="{{ url_for('index') }}"
                        >
                            <i class="bi bi-house-door action-icon"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        {% set add_active = current_endpoint == 'add_task' %}
                        <a
                            class="nav-link d-flex align-items-center gap-2 {{ 'active' if add_active }}"
                            {% if add_active %}aria-current="page"{% endif %}
                            href="{{ url_for('add_task') }}"
                        >
                            <i class="bi bi-plus-circle action-icon"></i>
                            <span>Add Task</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-right action-icon"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
                <div class="d-none d-lg-flex align-items-center ms-lg-3">
                    <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm theme-toggle"
                        data-theme-toggle
                        aria-label="Switch to dark mode"
                        aria-pressed="false"
                    >
                        <span class="theme-toggle-icon" aria-hidden="true">ðŸŒž</span>
                        <span class="visually-hidden">Toggle theme</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="container py-4">
            {% block content %}{% endblock %}
        </div>
    </main>

    {% if user %}
        <a class="btn btn-primary fab shadow" href="{{ url_for('add_task') }}" aria-label="Add task">
            <i class="bi bi-plus-lg action-icon"></i>
        </a>
    {% endif %}

    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"
    ></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const body = document.body;
            const transitionDuration = 250;

            if (body.classList.contains('page-transition')) {
                requestAnimationFrame(() => {
                    body.classList.add('is-visible');
                });

                const shouldIgnoreLink = (link, event) => {
                    if (!link) {
                        return true;
                    }

                    const href = link.getAttribute('href');
                    if (!href || href.startsWith('#') || href.startsWith('javascript:')) {
                        return true;
                    }

                    if (link.hasAttribute('data-page-transition-ignore') || link.hasAttribute('data-bs-toggle')) {
                        return true;
                    }

                    if (link.target && link.target !== '_self') {
                        return true;
                    }

                    if (link.hasAttribute('download')) {
                        return true;
                    }

                    if (event) {
                        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
                            return true;
                        }

                        if (event.button && event.button !== 0) {
                            return true;
                        }
                    }

                    try {
                        const protocol = link.protocol;
                        if (
                            protocol &&
                            protocol !== window.location.protocol &&
                            protocol !== 'http:' &&
                            protocol !== 'https:'
                        ) {
                            return true;
                        }

                        if (link.origin !== window.location.origin) {
                            return true;
                        }
                    } catch (error) {
                        return true;
                    }

                    return false;
                };

                const triggerFadeOut = (callback) => {
                    if (!body.classList.contains('is-exiting')) {
                        body.classList.add('is-exiting');
                    }

                    window.setTimeout(callback, transitionDuration);
                };

                document.querySelectorAll('a[href]').forEach((link) => {
                    link.addEventListener('click', (event) => {
                        if (shouldIgnoreLink(link, event)) {
                            return;
                        }

                        event.preventDefault();
                        triggerFadeOut(() => {
                            window.location.href = link.href;
                        });
                    });
                });

                document.querySelectorAll('form').forEach((form) => {
                    form.addEventListener('submit', () => {
                        if (!body.classList.contains('is-exiting')) {
                            body.classList.add('is-exiting');
                        }
                    });
                });

                window.addEventListener('pageshow', (event) => {
                    if (event.persisted) {
                        body.classList.remove('is-exiting');
                        requestAnimationFrame(() => {
                            body.classList.add('is-visible');
                        });
                    }
                });
            }

            const themeUtils = window.schedulistTheme || {
                getStoredTheme: () => null,
                setStoredTheme: () => {},
                getPreferredTheme: () => {
                    const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
                    return mediaQuery && mediaQuery.matches ? 'dark' : 'light';
                },
                applyTheme: (theme) => document.documentElement.setAttribute('data-bs-theme', theme),
            };

            const themeButtons = document.querySelectorAll('[data-theme-toggle]');

            const syncButtons = (theme) => {
                themeButtons.forEach((button) => {
                    const icon = button.querySelector('.theme-toggle-icon');
                    if (icon) {
                        icon.textContent = theme === 'dark' ? 'ðŸŒ™' : 'ðŸŒž';
                    }
                    button.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
                    button.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
                });
            };

            const setTheme = (theme) => {
                themeUtils.applyTheme(theme);
                syncButtons(theme);
            };

            const initialTheme = document.documentElement.getAttribute('data-bs-theme') || themeUtils.getPreferredTheme();
            setTheme(initialTheme);

            themeButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                    const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    setTheme(nextTheme);
                    themeUtils.setStoredTheme(nextTheme);
                });
            });

            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (event) => {
                    if (themeUtils.getStoredTheme()) {
                        return;
                    }
                    const newTheme = event.matches ? 'dark' : 'light';
                    setTheme(newTheme);
                });
            }

            const activateIconPop = () => {
                const icons = document.querySelectorAll('.action-icon');
                icons.forEach((icon) => {
                    const interactiveParent = icon.closest('a, button');
                    if (!interactiveParent || interactiveParent.dataset.iconPopBound === 'true') {
                        return;
                    }

                    interactiveParent.dataset.iconPopBound = 'true';

                    const handleClick = () => {
                        icon.classList.remove('is-popping');
                        // Force reflow to allow re-triggering the animation
                        void icon.offsetWidth;
                        icon.classList.add('is-popping');
                    };

                    interactiveParent.addEventListener('click', handleClick);
                    icon.addEventListener('animationend', () => {
                        icon.classList.remove('is-popping');
                    });
                });
            };

            activateIconPop();
        });
    </script>
</body>
</html>
